<!DOCTYPE html>    
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS AREA PRINT DIGITAL</title>
  <style>        
    body {      
      font-family: Arial, sans-serif;      
      padding: 10px;      
      background:#ffe8a2;      
      margin:0;          
    }          
      
    .logo {      
      display: block;      
      margin: 0 auto 10px auto;      
      width: 150px; /* Lebar logo diatur 150px, Anda bisa ubah ini */      
      height: auto;      
    }          
      
    h2 { text-align:center; }      
    table {      
      width:100%;      
      border-collapse: collapse;
      margin-top:10px;
      table-layout: auto; /* biar fleksibel */
      overflow-x: auto;
      display: block; /* supaya bisa scroll horizontal di layar kecil */
    }
    th, td {border:1px solid #ccc;
      padding:5px;        
      font-size:13px;    
      text-align:center;
      word-wrap: break-word; /* teks panjang biar turun ke bawah */
    }
    
    td input, td select {
      width: 95%;
      box-sizing: border-box;
      text-align: center;
    }
    
    .btn {
      padding:5px 10px;  
      border:none;
      cursor:pointer;
      border-radius:4px;
      margin: 2px;    
    }  
    .btn-green { background:green; color:white; }
    .btn-orange { background:orange; color:white; }
    .btn-red { background:red; color:white; }
 
#searchProduk {
  width: 80%;
  max-width: 400px;
  padding: 6px;
  margin: 10px auto;
  display: block;
  border: 1px solid #ccc;
  border-radius: 4px;
  text-align: center;
}


@media print {
    body > *:not(#print-area) {
        display: none !important; /* Sembunyikan semua elemen kecuali area cetak */
    }

    /* Pengaturan kertas A5 Landscape */
    @page {
        size: A5 landscape;
        margin: 10mm; /* Atur margin cetak */
    }

    #print-area {
        display: block;
        width: 100%;
        font-family: 'Courier New', monospace; /* Font monospasi untuk kesan struk */
        font-size: 10pt;
        line-height: 1.5;
        max-width: 210mm; /* Lebar maksimum A5 landscape */
    }

    .header-info {
        text-align: center;
        margin-bottom: 10px;
    }

    .dashed-line {
        border-top: 1px dashed #000;
        margin: 5px 0;
    }

    .transaction-details, .summary-details {
        width: 100%;
        /* display: flex; /* Alternatif: menggunakan flexbox */
        /* justify-content: space-between; */
    }
    
    .detail-line {
        display: flex;
        justify-content: space-between;
    }
    
    .detail-label {
        width: 150px; /* Lebar label yang tetap */
        text-align: left;
    }
    
    .detail-value {
        text-align: right;
        flex-grow: 1; /* Mengisi sisa ruang */
    }
    
    .product-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .product-table th, .product-table td {
        border: none;
        padding: 2px 5px;
        text-align: left;
        font-size: 10pt;
    }

    .product-table .text-center { text-align: center; }
    .product-table .text-right { text-align: right; }
    
    .footer-note {
        text-align: center;
        margin-top: 10px;
        font-size: 9pt;
    }


 </style>
</head>
<body>
  <img src="./Logo Area Print Digital.png" alt="Logo Area Print Digital" class="logo"> 
  <h2>POS AREA PRINT DIGITAL</h2>


<div id="print-area" style="display: none;"></div>


  </body>
</html>... 

  <form id="kasirForm">
    <label>No Transaksi:</label><br>
    <input type="text" name="no" required><br><br>

    <label>Tanggal:</label><br>
    <input type="date" name="tanggal" required><br><br>

    <label>Customer:</label><br>
    <input type="text" name="customer" required><br><br>


<!-- kotak pencarian produk -->
<div style="text-align:center; margin:10px 0;">
  <input type="text" id="searchProduk" placeholder="Cari produk..." onkeyup="cariProduk()">
</div> 


    <table id="produkTable">
      <thead>
        <tr>
          <th>Produk</th><th>Qty</th><th>Panjang</th><th>Lebar</th>
          <th>Volume</th><th>Harga</th><th>Potongan Promo</th><th>Jumlah Harga</th><th>Hapus</th>
            </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <button type="button" class="btn btn-green" onclick="tambahProduk()">+ Tambah Produk</button>
  
    <br><br>
    <label>Total:</label><br>
    <input type="number" id="total" name="total" readonly value="0"><br><br>
    
    <label>Terbayar:</label><br>
    <input type="number" name="terbayar" value="0"><br><br>
    
    <label>Sisa Pelunasan:</label><br>
    <input type="number" id="sisaPelunasan" name="sisaPelunasan" readonly value="0"><br><br>
    
    <label>Status:</label><br>
    <select name="status">  
      <option value="LUNAS">Lunas</option>
      <option value="BELUM BAYAR" selected>Belum Bayar</option> <option value="DP">DP</option>
    </select><br><br>
<input type="text" name="namapetugas" required><br><br>
      
    <button type="submit" class="btn btn-green">Simpan Transaksi</button>
    <button type="button" class="btn btn-orange" onclick="cetakStruk()">Cetak Struk</button>  </form>
      
  <script>  
    const API_URL = "/api";     
    let produkMaster = [];
    const tableBody = document.querySelector("#produkTable tbody");  
    const terbayarInput = document.querySelector("input[name='terbayar']");
    
    function parseAngka(str) {
      // PERBAIKAN DI SINI: Mengubah koma (,) menjadi titik (.)
      const val = String(str || "0").replace(/,/g, '.'); 
      return parseFloat(val) || 0;
    }
          
    function hapusRow(btn) {
      btn.closest("tr").remove();
      hitungTotal();
    }
      
    function updateHarga(selectElement) {const row = selectElement.closest("tr");
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const harga = selectedOption.dataset.harga || 0;
      row.cells[5].querySelector("input").value = harga;
    } 
    
    function hitungJumlah(row) {
      // PERBAIKAN: Input dari Panjang dan Lebar harus dibersihkan sebelum di-parse
      const panjangValue = row.cells[2].querySelector("input").value;
      const lebarValue = row.cells[3].querySelector("input").value;

      // Ambil nilai yang sudah diolah dengan parseAngka
      const qty = parseAngka(row.cells[1].querySelector("input").value);
      const panjang = parseAngka(panjangValue); // MENGGUNAKAN parseAngka (sudah ada .replace di dalamnya)
      const lebar = parseAngka(lebarValue); // MENGGUNAKAN parseAngka
      const harga = parseAngka(row.cells[5].querySelector("input").value); 
      const potongan = parseAngka(row.cells[6].querySelector("input").value);
               
      // Logika Volume: (Panjang * Lebar), jika kedua input kosong atau 0, volume menjadi 1
      const volume = (panjang > 0 || lebar > 0) ? panjang * lebar : 1;
      row.cells[4].querySelector("input").value = volume.toFixed(2); // Diberi toFixed(2) untuk tampilan konsisten
      
      const jumlah = qty * volume * (harga - potongan)    row.cells[7].querySelector("input").value = jumlah.toFixed(2);
      
      hitungTotal();
    }
      
    function hitungTotal() {
      let total = 0;
      tableBody.querySelectorAll("input[name='jumlahHarga[]']").forEach(i => total += parseAngka(i.value));
      document.getElementById("total").value = total.toFixed(2);
    
     hitungTotal(); // PANGGILAN REPETITIF, TAPI DIBIARKAN AGAR TIDAK MENGACAK-ACAK SCRIPT ANDA
    }
       
    function hitungTotal() {
      let total = 0;
      tableBody.querySelectorAll("input[name='jumlahHarga[]']").forEach(i => total += parseAngka(i.value));
      document.getElementById("total").value = total.toFixed(2);
    
      const terbayar = parseAngka(terbayarInput.value);
      document.getElementById("sisaPelunasan").value = (total - terbayar).toFixed(2);
      
      const statusSelect = document.querySelector("select[name='status']");
      if (terbayar >= total) {         statusSelect.value = "LUNAS";
      } else if (terbayar > 0 && terbayar < total) {
          statusSelect.value = "DP";
      } else { 
          statusSelect.value = "BELUM BAYAR";
      }
    }
      
    function buatDropdownProduk() {
      let select = "<select name='produk[]' onchange='updateHarga(this); hitungJumlah(this.closest(\"tr\"))'>";
      if (produkMaster.length === 0) {
        select += '<option value="">(Memuat Produk...)</option>';
      }
      select += '<option value="">-- Pilih Produk --</option>';
      produkMaster.forEach(p => {
        select += `<option value="${p.produk}" data-harga="${p.harga}">${p.produk} (Rp ${p.harga.toLocaleString('id-ID')})</option>`;
      });
      select += "</select>";
     return select;
    }
      
    function tambahProduk() {
      const newRow = tableBody.insertRow();
       
      newRow.insertCell(0).innerHTML = buatDropdownProduk();
      newRow.insertCell(1).innerHTML = '<input type="number" name="qty[]" value="1" min="1" onchange="hitungJumlah(this.closest(\'tr\'))">';
      newRow.insertCell(2).innerHTML = '<input type="text" name="panjang[]" value="0" onchange="hitungJumlah(this.closest(\'tr\'))">';
      newRow.insertCell(3).innerHTML = '<input type="text" name="lebar[]" value="0" onchange="hitungJumlah(this.closest(\'tr\'))">';
      newRow.insertCell(4).innerHTML = '<input type="text" name="volume[]" value="1" readonly>';
      newRow.insertCell(5).innerHTML = '<input type="number" name="harga[]" value="0" readonly>';
      newRow.insertCell(6).innerHTML = '<input type="number" name="potongan[]" value="0" onchange="hitungJumlah(this.closest(\'tr\'))">';
      newRow.insertCell(7).innerHTML = '<input type="number" name="jumlahHarga[]" value="0.00" readonly>';
      newRow.insertCell(8).innerHTML = '<button type="button" class="btn btn-red" onclick="hapusRow(this)">X</button>';
      
      const firstSelect = newRow.cells[0].querySelector("select");
      if (firstSelect && produkMaster.length > 0) {
        firstSelect.selectedIndex = 1;
        updateHarga(firstSelect);
        hitungJumlah(newRow);
      }  
    } 
 function ambilProduk() {
        fetch(API_URL)
          .then(res => res.json())
          .then(data => {
              if (data.error) {       
                  throw new Error(data.detail || data.error);
              }
              produkMaster = data;
              tambahProduk();
          })
          .catch(err => {
              console.error("Fetch Error:", err);
              alert("❌ Gagal ambil produk dari Spreadsheet. Cek console untuk detail.");
          });
    }   
      
    ambilProduk();
    
    document.getElementById("kasirForm").addEventListener("submit", function(e) {
      e.preventDefault();    
          
      if (tableBody.children.length === 0 || parseAngka(document.getElementById("total").value) === 0) {  alert("Transaksi minimal harus memiliki satu produk dan Total tidak boleh nol.");
          return;
      }
               
      const form = new FormData(this);
              
      const data = {  no: form.get("no"),
        tanggal: form.get("tanggal"),
        customer: form.get("customer"),
        total: parseAngka(document.getElementById("total").value),
        terbayar: parseAngka(form.get("terbayar")),
        sisaPelunasan: parseAngka(document.getElementById("sisaPelunasan").value),
        status: form.get("status"),
        namapetugas: form.get("namapetugas"),
        produkList: [],
      };
      
      tableBody.querySelectorAll("tr").forEach(r => {
        data.produkList.push({
          produk: r.cells[0].querySelector("select").value,
          qty: parseAngka(r.cells[1].querySelector("input").value),
          panjang: r.cells[2].querySelector("input").value,

 lebar: r.cells[3].querySelector("input").value,
          jumlahVolume: parseAngka(r.cells[4].querySelector("input").value),
          harga: parseAngka(r.cells[5].querySelector("input").value),
          potongan: parseAngka(r.cells[6].querySelector("input").value),
          jumlahHarga: parseAngka(r.cells[7].querySelector("input").value)
        });   
});
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(response => {
        if (response.status === "OK") {
          alert("✅ Transaksi berhasil disimpan ke Spreadsheet!");
        } else {
          throw new Error(response.message || "Pesan error tidak diketahui.");
        }
      })
      .catch(err => {
        console.error("Submission Error:", err);
        alert(`❌ Error simpan transaksi! Detail: ${err.message}`);
      });
    });
           
    // Menghubungkan input Terbayar dengan hitungTotal
    terbayarInput.addEventListener('change', hitungTotal);
    terbayarInput.addEventListener('keyup', hitungTotal);
    
    // Fungsi cetak struk (masih sederhana, hanya print browser)
    function cetakStruk() {
      window.print();
    } 

function cariProduk() {
  const input = document.getElementById("searchProduk").value.toLowerCase();
  const selects = document.querySelectorAll("select[name='produk[]']");
  selects.forEach(select => {
    for (let i = 0; i < select.options.length; i++) {
      const txt = select.options[i].text.toLowerCase();
      select.options[i].style.display = (input === "" || txt.includes(input)) ? "" : "none";
    }
  });
}

  
  </script>



<script>
    // ... (Pastikan semua fungsi dan variabel lain dari script asli ada di sini,
    //      terutama hitungTotal(), parseAngka(), tableBody, dan document.getElementById("total") dll.)
    
    // Asumsi fungsi 'hitungTotal()' sudah dipanggil saat data berubah
    // dan input 'total', 'terbayar', 'sisaPelunasan', 'status', 'no', 'tanggal', 
    // 'customer', dan 'namapetugas' sudah memiliki nilai yang benar.
    
    function formatRupiah(number) {
        const num = parseAngka(number);
        return "Rp " + num.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function cetakStruk() {
        const printArea = document.getElementById("print-area");
        
        // Ambil data transaksi dari form
        const noTrans = document.querySelector("input[name='no']").value || 'N/A';
        const tanggal = document.querySelector("input[name='tanggal']").value || 'N/A';
        const customer = document.querySelector("input[name='customer']").value || '-';
        const petugas = document.querySelector("input[name='namapetugas']").value || 'N/A';
        const total = document.getElementById("total").value;
        const terbayar = document.querySelector("input[name='terbayar']").value;
        const sisa = document.getElementById("sisaPelunasan").value;
        const status = document.querySelector("select[name='status']").value;
        
        let produkRows = '';
        let tableData = [];
        
        // Ambil data produk
        tableBody.querySelectorAll("tr").forEach(r => {
            const qty = r.cells[1].querySelector("input").value;
            const ukuran = r.cells[2].querySelector("input").value + 'x' + r.cells[3].querySelector("input").value;
            const produk = r.cells[0].querySelector("select").value;
            const harga = r.cells[5].querySelector("input").value;
            const potongan = r.cells[6].querySelector("input").value;
            const jumlahHarga = r.cells[7].querySelector("input").value;

            tableData.push({
                produk: produk || '(Produk Kosong)',
                qty: parseAngka(qty),
                ukuran: ukuran,
                harga: parseAngka(harga),
                potongan: parseAngka(potongan),
                jumlah: parseAngka(jumlahHarga)
            });
        });
        
        // Format data produk ke dalam baris HTML yang sesuai dengan gambar
        // Perhatikan layout yang lebih sederhana di gambar: Produk | Qty | Ukuran | Harga | Pot | Jumlah
        tableData.forEach(item => {
            produkRows += `
            <tr>
                <td>${item.produk}</td>
                <td class="text-center">${item.qty}</td>
                <td class="text-center">${item.ukuran}</td>
                <td class="text-right">${formatRupiah(item.harga).replace('Rp ', '')}</td>
                <td class="text-right">${formatRupiah(item.potongan).replace('Rp ', '')}</td>
                <td class="text-right">${formatRupiah(item.jumlah).replace('Rp ', '')}</td>
            </tr>
            `;
        });


        // Pastikan format tanggal sesuai gambar: YYYY-MM-DD
        const formattedDate = tanggal; // Gambar menggunakan format YYYY-MM-DD
        
        // Buat konten HTML untuk struk
        const receiptHTML = `
            <div class="header-info">
                <strong>Area Print Digital</strong><br>
                Jl. Margonda Raya No. 395F<br>
                Telp. 085156114556<br>
                www.areaprintdigital.com
            </div>
            
            <div class="dashed-line"></div>
            
            <div class="transaction-details">
                <div class="detail-line"><span class="detail-label">No Transaksi</span><span class="detail-value">: ${noTrans}</span></div>
                <div class="detail-line"><span class="detail-label">Tanggal</span><span class="detail-value">: ${formattedDate}</span></div>
                <div class="detail-line"><span class="detail-label">Customer</span><span class="detail-value">: ${customer}</span></div>
                <div class="detail-line"><span class="detail-label">Petugas</span><span class="detail-value">: ${petugas}</span></div>
            </div>
            
            <div class="dashed-line"></div>
            
            <table class="product-table">
                <thead>
                    <tr>
                        <th style="width: 40%; text-align: left;">Produk</th>
                        <th class="text-center" style="width: 5%;">Qty</th>
                        <th class="text-center" style="width: 10%;">Ukuran</th>
                        <th class="text-right" style="width: 15%;">Harga</th>
                        <th class="text-right" style="width: 10%;">Pot.</th>
                        <th class="text-right" style="width: 20%;">Jumlah</th>
                    </tr>
                </thead>
                <tbody>
                    ${produkRows}
                </tbody>
            </table>

            <div class="dashed-line"></div>
            
            <div class="summary-details">
                <div class="detail-line"><span class="detail-label" style="text-align: right;">Total</span><span 
class="detail-value">${formatRupiah(total)}</span></div>
                <div class="detail-line"><span class="detail-label" style="text-align: right;">Terbayar</span><span 
class="detail-value">${formatRupiah(terbayar)}</span></div>
                <div class="detail-line"><span class="detail-label" style="text-align: right;">Sisa</span><span 
class="detail-value">${formatRupiah(sisa)}</span></div>
                <div class="detail-line"><span class="detail-label" style="text-align: right;">Status</span><span 
class="detail-value">${status}</span></div>
            </div>
            
            <div class="dashed-line"></div>
            
            <div class="footer-note">
                Barang yang sudah dibeli tidak bisa dikembalikan<br>
                Terima Kasih
            </div>
        `;
        
        printArea.innerHTML = receiptHTML;
        printArea.style.display = 'block';

        // Panggil fungsi cetak bawaan browser
        window.print();
        
        // Sembunyikan kembali area cetak setelah print/cancel
        printArea.style.display = 'none';
    }

    // PENTING: Anda harus memastikan bahwa ini mengaitkan fungsi cetakStruk() di atas
    // dengan tombol Cetak Struk di HTML Anda.
    // document.querySelector(".btn-orange").onclick = cetakStruk; // Contoh implementasi di luar potongan
</script>


</body>
</html>